# Проект по SQL

Коронавирус застал мир врасплох, изменив привычный порядок вещей. В свободное время жители городов больше не выходят на улицу, не посещают кафе и торговые центры. Зато стало больше времени для книг.

Задача: проанализивать данные, ответить на вопросы исследования, чтобы помочь стартапу сформулировать ценностное предложение для нового продукта.

**Описание данных:**

Таблица **books**.
Содержит данные о книгах:

- book_id — идентификатор книги;
- author_id — идентификатор автора;
- title — название книги;
- num_pages — количество страниц;
- publication_date — дата публикации книги;
- publisher_id — идентификатор издателя.

Таблица **authors**.
Содержит данные об авторах:

- author_id — идентификатор автора;
- author — имя автора.

Таблица **publishers**.
Содержит данные об издательствах:

- publisher_id — идентификатор издательства;
- publisher — название издательства;

Таблица **ratings**.
Содержит данные о пользовательских оценках книг:

- rating_id — идентификатор оценки;
- book_id — идентификатор книги;
- username — имя пользователя, оставившего оценку;
- rating — оценка книги.

Таблица **reviews**.
Содержит данные о пользовательских обзорах:

- review_id — идентификатор обзора;
- book_id — идентификатор книги;
- username — имя автора обзора;
- text — текст обзора.

**Схема данных**

![Image.png](attachment:Image.png)

**Ход проекта:**
- Исследование таблиц, выведение первых строк каждой таблицы
- SQL-запросы, позволяющие ответить на вопросы исследования

## Исследование таблиц, выведение первых строк каждой таблицы


```python
SELECT * 
FROM books 
LIMIT 5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>book_id</th>
      <th>author_id</th>
      <th>title</th>
      <th>num_pages</th>
      <th>publication_date</th>
      <th>publisher_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>546</td>
      <td>'Salem's Lot</td>
      <td>594</td>
      <td>2005-11-01</td>
      <td>93</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>465</td>
      <td>1 000 Places to See Before You Die</td>
      <td>992</td>
      <td>2003-05-22</td>
      <td>336</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>407</td>
      <td>13 Little Blue Envelopes (Little Blue Envelope...</td>
      <td>322</td>
      <td>2010-12-21</td>
      <td>135</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>82</td>
      <td>1491: New Revelations of the Americas Before C...</td>
      <td>541</td>
      <td>2006-10-10</td>
      <td>309</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>125</td>
      <td>1776</td>
      <td>386</td>
      <td>2006-07-04</td>
      <td>268</td>
    </tr>
  </tbody>
</table>
</div>




```python
SELECT * 
FROM authors 
LIMIT 5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>author_id</th>
      <th>author</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>A.S. Byatt</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Aesop/Laura Harris/Laura Gibbs</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Agatha Christie</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Alan Brennert</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Alan Moore/David   Lloyd</td>
    </tr>
  </tbody>
</table>
</div>




```python
SELECT * 
FROM publishers 
LIMIT 5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>publisher_id</th>
      <th>publisher</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Ace</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Ace Book</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Ace Books</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Ace Hardcover</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Addison Wesley Publishing Company</td>
    </tr>
  </tbody>
</table>
</div>




```python
SELECT * 
FROM ratings 
LIMIT 5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rating_id</th>
      <th>book_id</th>
      <th>username</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>ryanfranco</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>grantpatricia</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>brandtandrea</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2</td>
      <td>lorichen</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>2</td>
      <td>mariokeller</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
SELECT * 
FROM reviews 
LIMIT 5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>review_id</th>
      <th>book_id</th>
      <th>username</th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>brandtandrea</td>
      <td>Mention society tell send professor analysis. ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>ryanfranco</td>
      <td>Foot glass pretty audience hit themselves. Amo...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>2</td>
      <td>lorichen</td>
      <td>Listen treat keep worry. Miss husband tax but ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>3</td>
      <td>johnsonamanda</td>
      <td>Finally month interesting blue could nature cu...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>3</td>
      <td>scotttamara</td>
      <td>Nation purpose heavy give wait song will. List...</td>
    </tr>
  </tbody>
</table>
</div>



## Ответы на вопросы исследования

### Посчитайте, сколько книг вышло после 1 января 2000 года;


```python
SELECT COUNT(book_id)
FROM books 
WHERE publication_date >= '2000-01-01'
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>821</td>
    </tr>
  </tbody>
</table>
</div>



**Вывод:** После 1 января 2000 года вышла 821 книга.

### Для каждой книги посчитайте количество обзоров и среднюю оценку;


```python
SELECT b.title,
       b.book_id,
       ROUND(AVG(r.rating)) rating,
       COUNT(DISTINCT(rv.review_id)) review_cnt
FROM books as b
LEFT JOIN ratings r on r.book_id=b.book_id
LEFT JOIN reviews rv on rv.book_id=b.book_id

GROUP BY b.book_id
ORDER BY rating DESC, review_cnt DESC

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>book_id</th>
      <th>rating</th>
      <th>review_cnt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Snow Flower and the Secret Fan</td>
      <td>581</td>
      <td>5.0</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A Dirty Job (Grim Reaper  #1)</td>
      <td>17</td>
      <td>5.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Howl's Moving Castle (Howl's Moving Castle  #1)</td>
      <td>334</td>
      <td>5.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Maus I: A Survivor's Tale: My Father Bleeds Hi...</td>
      <td>423</td>
      <td>5.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Drums of Autumn (Outlander  #4)</td>
      <td>203</td>
      <td>5.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>995</th>
      <td>The Mermaid Chair</td>
      <td>794</td>
      <td>2.0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>996</th>
      <td>The Kitchen God's Wife</td>
      <td>772</td>
      <td>2.0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>997</th>
      <td>Junky</td>
      <td>371</td>
      <td>2.0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>998</th>
      <td>His Excellency: George Washington</td>
      <td>316</td>
      <td>2.0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>999</th>
      <td>Harvesting the Heart</td>
      <td>303</td>
      <td>2.0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>1000 rows × 4 columns</p>
</div>



**Вывод:** Всего в базе у нас 1000 книг, в запросе мы вывели средний рейтинг и количество обзоров по каждой книге. 

Рейтинг всех книг варьируется от 5 до 2. 
Количество отзывов варьируется от 7 до 1. 

### Определите издательство, которое выпустило наибольшее число книг толще 50 страниц — так вы исключите из анализа брошюры;


```python
SELECT p.publisher,
       COUNT(b.book_id) books_cnt
FROM books b
JOIN publishers p on p.publisher_id=b.publisher_id
WHERE b.num_pages >= 50
GROUP BY publisher
ORDER BY COUNT(b.book_id) DESC
LIMIT 1
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>publisher</th>
      <th>books_cnt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Penguin Books</td>
      <td>42</td>
    </tr>
  </tbody>
</table>
</div>



**Вывод:** Издательство Penguin Books выпустило наибольшее количество книг (42 книги) толще 50 страниц

### Определите автора с самой высокой средней оценкой книг — учитывайте только книги с 50 и более оценками;


```python
WITH new AS
(SELECT AVG(rating) rating ,
        book_id
FROM ratings
GROUP BY book_id
HAVING COUNT(rating_id) >= 50)

SELECT a.author, AVG(rating) rating
FROM new n
JOIN books b on b.book_id=n.book_id
JOIN authors a ON a.author_id=b.author_id
GROUP BY a.author
ORDER BY rating DESC
LIMIT 1
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>author</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>J.K. Rowling/Mary GrandPré</td>
      <td>4.283844</td>
    </tr>
  </tbody>
</table>
</div>



**Вывод:** Самый высокий средний рейтинг книг, которые оценивали 50 и больше раз у J.K. Rowling/Mary GrandPré, их рейтинг составил 4.28

### Посчитайте среднее количество обзоров от пользователей, которые поставили больше 48 оценок.


```python
SELECT COUNT(DISTINCT(rv.review_id)) / COUNT(DISTINCT(rv.username)) avg_review
FROM  reviews rv
JOIN ratings r ON r.username = rv.username
WHERE r.username IN ( 
                    SELECT username
                    FROM ratings
                    GROUP BY username
                    HAVING COUNT(rating_id) > 48
                    )

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>avg_review</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>24</td>
    </tr>
  </tbody>
</table>
</div>



**Вывод:**  Среднее количество обзоров от пользователей,которые поставии больше 48 оценок - 24 обзора

**Итоговый вывод:**
- Всего в данных у нас представлено 1000 книг.
- После 1 января 2000 года вышла 821 книга.
- Рейтинг всех книг варьируется от 5 до 2. 
- Количество отзывов варьируется от 7 до 1. 
- Издательство Penguin Books выпустило наибольшее количество книг (42 книги) толще 50 страниц.
- Самый высокий средний рейтинг книг, которые оценивали 50 и больше раз у J.K. Rowling/Mary GrandPré, их рейтинг составил 4.28
- Среднее количество обзоров от пользователей,которые поставии больше 48 оценок - 24 обзора
